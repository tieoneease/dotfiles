#!/usr/bin/env bash

set -euo pipefail

# Interactive setup for Google Calendar sync via vdirsyncer + khal.
# Creates an isolated GCP project for OAuth credentials, then adds
# as many Google accounts as you need.
#
# Usage: setup-google-calendar
#
# Re-running is safe — existing config is detected and preserved.
# On a new machine with the same GCP project, just re-enter credentials
# and re-authorize accounts.

VDIRSYNCER_DIR="$HOME/.config/vdirsyncer"
KHAL_DIR="$HOME/.config/khal"
DATA_DIR="$HOME/.local/share/vdirsyncer"
CALENDARS_DIR="$HOME/.local/share/calendars"
PROJECT_FILE="$VDIRSYNCER_DIR/gcp_project_id"

mkdir -p "$VDIRSYNCER_DIR" "$KHAL_DIR" "$DATA_DIR/status" "$CALENDARS_DIR"

# Read persisted project ID if available
PROJECT=""
if [[ -f "$PROJECT_FILE" ]]; then
    PROJECT="$(cat "$PROJECT_FILE")"
fi

# --- GCP project setup (one-time, idempotent) ---

setup_gcp_project() {
    if ! command -v gcloud &> /dev/null; then
        echo "gcloud CLI not found. Install it first:"
        echo "  yay -S google-cloud-cli"
        echo "  (or: https://cloud.google.com/sdk/docs/install)"
        exit 1
    fi

    echo "=== GCP Project Setup ==="
    echo ""
    echo "Sign into your PERSONAL Google account (the one that will own this project)."
    echo "This keeps the project portable across machines and tied to your own account."
    echo ""

    gcloud auth login

    local active_account
    active_account="$(gcloud config get account 2>/dev/null)"
    echo ""
    echo "Signed in as: $active_account"
    read -rp "Continue with this account? [Y/n] " response
    if [[ "$response" =~ ^[Nn]$ ]]; then
        echo "Run 'gcloud auth login' manually to switch accounts, then re-run this script."
        exit 0
    fi

    # Generate or reuse project ID
    if [[ -n "$PROJECT" ]]; then
        echo ""
        echo "Using saved project ID: $PROJECT"
    else
        local date_suffix
        date_suffix="$(date +%y%m%d)"
        local default_id="vdirsyncer-cal-${date_suffix}"
        echo ""
        read -rp "Project ID [$default_id]: " custom_id
        PROJECT="${custom_id:-$default_id}"
    fi

    # Create or reuse project
    if gcloud projects describe "$PROJECT" &> /dev/null; then
        echo "Project '$PROJECT' already exists — skipping creation."
    else
        echo "Creating project '$PROJECT'..."
        gcloud projects create "$PROJECT" --name="vdirsyncer Calendar Sync" --quiet
        echo "Project '$PROJECT' created."
    fi

    # Persist project ID for future re-runs / new machines
    echo -n "$PROJECT" > "$PROJECT_FILE"

    # Enable CalDAV API
    echo "Enabling CalDAV API..."
    gcloud services enable caldav.googleapis.com --project="$PROJECT" 2>/dev/null || true

    echo ""
    echo "Now set up OAuth credentials in the Cloud Console:"
    echo ""
    echo "  1. Open the link below"
    echo "  2. If prompted to configure the consent screen:"
    echo "     - Select 'External', fill in app name (e.g. 'vdirsyncer')"
    echo "     - IMPORTANT: Add ALL Google accounts you want to sync as test users"
    echo "       (e.g. personal@gmail.com, work@company.com, etc.)"
    echo "     - The app stays in 'Testing' mode — only test users can authorize"
    echo "  3. Go to Credentials → '+ CREATE CREDENTIALS' → 'OAuth client ID'"
    echo "  4. Application type: 'Desktop app'"
    echo "  5. Copy the Client ID and Client Secret"
    echo ""
    xdg-open "https://console.cloud.google.com/apis/credentials?project=$PROJECT" 2>/dev/null || \
        echo "  https://console.cloud.google.com/apis/credentials?project=$PROJECT"
    echo ""
}

setup_credentials() {
    if [[ -f "$VDIRSYNCER_DIR/client_id" ]] && [[ -f "$VDIRSYNCER_DIR/client_secret" ]]; then
        echo "OAuth credentials already saved."
        read -rp "Re-enter credentials? [y/N] " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            return
        fi
    fi

    echo ""
    echo "Paste the Client ID and Client Secret from the GCP Console."
    echo "  (Credentials page: https://console.cloud.google.com/apis/credentials?project=$PROJECT)"
    echo ""
    read -rp "Client ID: " client_id
    read -rp "Client Secret: " client_secret

    echo -n "$client_id" > "$VDIRSYNCER_DIR/client_id"
    echo -n "$client_secret" > "$VDIRSYNCER_DIR/client_secret"
    chmod 600 "$VDIRSYNCER_DIR/client_id" "$VDIRSYNCER_DIR/client_secret"
    echo "Credentials saved."
}

# --- Account management ---

# Collect existing account labels from config
get_existing_accounts() {
    local accounts=()
    if [[ -f "$VDIRSYNCER_DIR/config" ]]; then
        while IFS= read -r line; do
            if [[ "$line" =~ ^\[pair\ google_(.*)\]$ ]]; then
                accounts+=("${BASH_REMATCH[1]}")
            fi
        done < "$VDIRSYNCER_DIR/config"
    fi
    echo "${accounts[@]}"
}

add_accounts() {
    local accounts=()
    local existing
    existing=($(get_existing_accounts))

    if [[ ${#existing[@]} -gt 0 ]]; then
        echo ""
        echo "Existing accounts: ${existing[*]}"
        accounts=("${existing[@]}")
    fi

    while true; do
        echo ""
        read -rp "Add a Google Calendar account? [y/N] " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            break
        fi

        read -rp "Label (e.g. personal, work, freelance): " label
        label="${label,,}"  # lowercase
        label="${label// /_}"  # replace spaces with underscores

        if [[ " ${accounts[*]} " =~ " $label " ]]; then
            echo "Account '$label' already exists — skipping."
            continue
        fi

        accounts+=("$label")
        mkdir -p "$CALENDARS_DIR/$label"
        echo "Added account '$label'."
    done

    if [[ ${#accounts[@]} -eq 0 ]]; then
        echo "No accounts configured. Run this script again to add accounts."
        exit 0
    fi

    generate_vdirsyncer_config "${accounts[@]}"
    generate_khal_config "${accounts[@]}"
    auth_accounts "${accounts[@]}"
}

# --- Config generation ---

generate_vdirsyncer_config() {
    local accounts=("$@")

    cat > "$VDIRSYNCER_DIR/config" << EOF
[general]
status_path = "~/.local/share/vdirsyncer/status/"
EOF

    for label in "${accounts[@]}"; do
        cat >> "$VDIRSYNCER_DIR/config" << EOF

[pair google_${label}]
a = "${label}_local"
b = "${label}_remote"
collections = ["from b"]
metadata = ["color", "displayname"]

[storage ${label}_local]
type = "filesystem"
path = "~/.local/share/calendars/${label}/"
fileext = ".ics"

[storage ${label}_remote]
type = "google_calendar"
token_file = "~/.local/share/vdirsyncer/token_${label}"
client_id.fetch = ["command", "cat", "$VDIRSYNCER_DIR/client_id"]
client_secret.fetch = ["command", "cat", "$VDIRSYNCER_DIR/client_secret"]
EOF
    done

    echo "vdirsyncer config written to $VDIRSYNCER_DIR/config"
}

generate_khal_config() {
    local accounts=("$@")

    cat > "$KHAL_DIR/config" << 'EOF'
[calendars]
EOF

    for label in "${accounts[@]}"; do
        cat >> "$KHAL_DIR/config" << EOF
[[${label}]]
path = ~/.local/share/calendars/${label}/*
type = discover

EOF
    done

    cat >> "$KHAL_DIR/config" << 'EOF'
[locale]
timeformat = %H:%M
dateformat = %Y-%m-%d
longdatetimeformat = %Y-%m-%d %H:%M
EOF

    echo "khal config written to $KHAL_DIR/config"
}

# --- OAuth authorization ---

auth_accounts() {
    local accounts=("$@")

    echo ""
    echo "=== Authorizing accounts ==="
    echo "A browser window will open for each account. Sign in and click 'Allow'."
    echo ""

    for label in "${accounts[@]}"; do
        if [[ -f "$DATA_DIR/token_${label}" ]]; then
            echo "Account '$label' already authorized — skipping."
            continue
        fi

        echo "Discovering calendars for '$label'..."
        echo "  (Sign in with the Google account for '$label' in the browser)"
        yes | vdirsyncer discover "google_${label}"
        echo "Account '$label' authorized."
        echo ""
    done

    echo "Running initial sync..."
    vdirsyncer sync
    echo ""

    echo "=== Verification ==="
    echo "Available calendars:"
    khal printcalendars
    echo ""
    echo "Upcoming events (next 7 days):"
    khal list today 7d
}

# --- Main ---

echo "Google Calendar Setup for Noctalia Shell"
echo "========================================="
echo ""

setup_gcp_project
setup_credentials
add_accounts

echo ""
echo "Done! Your calendars will sync every 5 minutes via systemd timer."
echo "Check timer status: systemctl --user status vdirsyncer.timer"
echo "Noctalia Shell will show calendar events automatically."
